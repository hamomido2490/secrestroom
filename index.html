// ===== STATE & DATA =====
const state = {
    currentQ: 0,
    userAnswers: [],
    personalityScore: { D: 0, I: 0, S: 0, C: 0 },
    userData: { age: null, gender: '', dob: '' },
    lang: 'ar', // default language
    zodiacSign: '',
    partnerAnalysis: null,
    resultText: ''
};

// Zodiac Signs Data
const zodiacSignsData = {
    ar: [
        { name: 'الحمل', start: '03-21', end: '04-19' },
        { name: 'الثور', start: '04-20', end: '05-20' },
        { name: 'الجوزاء', start: '05-21', end: '06-20' },
        { name: 'السرطان', start: '06-21', end: '07-22' },
        { name: 'الأسد', start: '07-23', end: '08-22' },
        { name: 'العذراء', start: '08-23', end: '09-22' },
        { name: 'الميزان', start: '09-23', end: '10-22' },
        { name: 'العقرب', start: '10-23', end: '11-21' },
        { name: 'القوس', start: '11-22', end: '12-21' },
        { name: 'الجدي', start: '12-22', end: '01-19' },
        { name: 'الدلو', start: '01-20', end: '02-18' },
        { name: 'الحوت', start: '02-19', end: '03-20' }
    ],
    en: [
        { name: 'Aries', start: '03-21', end: '04-19' },
        { name: 'Taurus', start: '04-20', end: '05-20' },
        { name: 'Gemini', start: '05-21', end: '06-20' },
        { name: 'Cancer', start: '06-21', end: '07-22' },
        { name: 'Leo', start: '07-23', end: '08-22' },
        { name: 'Virgo', start: '08-23', end: '09-22' },
        { name: 'Libra', start: '09-23', end: '10-22' },
        { name: 'Scorpio', start: '10-23', end: '11-21' },
        { name: 'Sagittarius', start: '11-22', end: '12-21' },
        { name: 'Capricorn', start: '12-22', end: '01-19' },
        { name: 'Aquarius', start: '01-20', end: '02-18' },
        { name: 'Pisces', start: '02-19', end: '03-20' }
    ]
};

// Translations
const translations = {
    ar: {
        welcome_title: "مرحباً في غرفة الأسرار",
        user_info_title: "معلوماتك الشخصية",
        user_info_desc: "دعنا نتعرف عليك أكثر لنقدم لك تحليلاً دقيقاً",
        age_label: "العمر",
        gender_label: "الجنس",
        dob_label: "تاريخ الميلاد",
        submit_user_info: "التالي",
        intro_title: "استعد لرحلة اكتشاف الذات",
        intro_subtitle: "تحليل شخصيتك ومعرفة رفيق دربك",
        intro_desc: "ستخوض رحلة من 20 سؤالاً مصممة خصيصاً لكشف أعماق شخصيتك",
        intro_p1: "سنحلل شخصيتك وفقاً لأحدث النظريات النفسية",
        intro_p2: "وسنساعدك في اكتشاف الشريك المثالي لك",
        start_btn: "ابدأ الرحلة",
        progress: "التقدم:",
        next_btn: "التالي",
        final_results_btn: "عرض النتائج",
        restart_btn: "ابدأ من جديد",
        share_btn: "مشاركة النتيجة",
        copy_btn: "نسخ النتيجة",
        alert_missing_fields: "يرجى ملء جميع الحقول",
        alert_invalid_dob: "تاريخ ميلاد غير صحيح",
        alert_no_answer: "يرجى اختيار إجابة",
        alert_copied: "تم نسخ النتيجة بنجاح!",
        footer2: "مطور بحب ❤️ لمساعدتك في فهم نفسك أكثر",
        male: "ذكر",
        female: "أنثى",
        other: "آخر",
        compatibility_title: "نسبة التوافق",
        partner_traits: "صفات الشريك المثالي",
        relationship_advice: "نصائح للعلاقة",
        analysis_intro: "بعد تحليل إجاباتك، تم تحديد طبيعة شخصيتك على النحو التالي:",
        personality_section: "تحليل شخصيتك",
        partner_section: "الشريك المثالي لك",
        partner_analysis_title: "تحليل مفصل للشريك المثالي",

        // Questions
        q1: "عندما تستيقظ في الصباح، ما أول شيء يخطر ببالك؟",
        o1_1: "أنا متحمس لأبدأ يومي!",
        o1_2: "هل كل شيء تحت السيطرة؟",
        o1_3: "هل سأكون كافيًا اليوم؟",
        o1_4: "أريد أن أفهم معنى هذا اليوم",

        q2: "في لقاء اجتماعي جديد، ماذا تفعل؟",
        o2_1: "أبدأ الحديث مع الجميع بسرعة",
        o2_2: "أراقب أولًا ثم أتحدث مع شخص واحد",
        o2_3: "أركز على من يمكن أن يفيدني أو أفيد منه",
        o2_4: "أحاول فهم مشاعر الآخرين بسرعة",

        q3: "ما نوع المهمة التي تجعلك 'تُنسى' من نفسك؟",
        o3_1: "التحديات السريعة والملتزمة بالوقت",
        o3_2: "التحليل العميق للبيانات أو الأنظمة",
        o3_3: "مساعدة شخص على تجاوز أزمة",
        o3_4: "تنظيم فريق لتحقيق هدف منظم",

        q4: "ما أكثر شيء تبحث عنه في الصداقات؟",
        o4_1: "المرح والطاقة",
        o4_2: "الولاء والاستقرار",
        o4_3: "العمق والمعنى",
        o4_4: "التحدي الفكري",

        q5: "كيف تتعامل مع الأخطاء؟",
        o5_1: "أتعلم وأتحرك بسرعة",
        o5_2: "أحلل ما حدث بدقة",
        o5_3: "أشعر بالذنب، لكنني أسامح نفسي",
        o5_4: "أتساءل: هل هذا يثبت أنني غير كافٍ؟",

        q6: "ما الذي يُشعرك بالفخر؟",
        o6_1: "تحقيق نتائج ملموسة",
        o6_2: "دعم شخص في أزمة",
        o6_3: "ابتكار فكرة جديدة",
        o6_4: "الالتزام بالواجبات والمسؤوليات",

        q7: "ما الذي تبحث عنه في قرار مهم؟",
        o7_1: "السرعة والنتائج",
        o7_2: "الإلهام والانطباع الأول",
        o7_3: "استقرار الفريق والعلاقات",
        o7_4: "التحليل العميق والمنطق",

        q8: "ماذا تفعل عندما تشعر بالضغط؟",
        o8_1: "أتحدى الموقف مباشرة",
        o8_2: "أبحث عن دعم من الآخرين",
        o8_3: "أبتعد مؤقتًا لأعيد التفكير",
        o8_4: "أحلل المشكلة من كل الزوايا",

        q9: "ما نوع الكتب أو المحتوى الذي تفضله؟",
        o9_1: "قصص نجاح، قيادة، تأثير",
        o9_2: "روايات، فلسفة، تأملات وجودية",
        o9_3: "نكت، فيديوهات مضحكة، ترفيه",
        o9_4: "أدلة عملية، خطوات، تقنيات",

        q10: "ما الذي يعطيك إحساسًا بالمعنى؟",
        o10_1: "تحقيق إنجازات كبيرة",
        o10_2: "خدمة الآخرين",
        o10_3: "فهم الكون أو النظام الكوني",
        o10_4: "الاستقرار والانتماء",

        q11: "كم مرة تغير رأيك بناءً على معلومة جديدة؟",
        o11_1: "نادرًا، أنا واثق من قراراتي",
        o11_2: "أحيانًا، إذا كانت الحجة قوية",
        o11_3: "غالبًا، لأنني أحب التعلم",
        o11_4: "دائمًا، لأنني أكره التصلب",

        q12: "ما الذي يُشعرك بالراحة؟",
        o12_1: "تحقيق الهدف",
        o12_2: "الضحك والتفاعل",
        o12_3: "الهدوء والاستقرار",
        o12_4: "النظام والفهم الكامل",

        q13: "ما هو شعارك في الحياة؟",
        o13_1: "النتيجة أهم من الطريقة",
        o13_2: "الحياة للمرح والتجربة",
        o13_3: "العلاقات تُبنى بالصبر والوفاء",
        o13_4: "الفهم يسبق كل شيء",

        q14: "كيف تتعامل مع الانتقاد؟",
        o14_1: "أتحداه وأثبت نفسي",
        o14_2: "أضحك وأحوله إلى نكتة",
        o14_3: "أتألم لكنني أتعلم",
        o14_4: "أحلله وأستفيد منه",

        q15: "ما نوع القيادة التي تُلهمك؟",
        o15_1: "قيادة حاسمة وسريعة",
        o15_2: "قيادة ملهمة ومحفزة",
        o15_3: "قيادة داعمة ومستقرة",
        o15_4: "قيادة منظمة وتحليلية",

        q16: "ما الذي يُشعرك بالإنجاز؟",
        o16_1: "إكمال مهمة صعبة",
        o16_2: "رؤية الآخرين سعداء بعملي",
        o16_3: "الحفاظ على التوازن والانسجام",
        o16_4: "اتباع نظام دقيق",

        q17: "ما الذي يُشعرك بالحرية؟",
        o17_1: "التحكم في مصيري",
        o17_2: "التعبير عن نفسي بحرية",
        o17_3: "العيش بسلام مع نفسي",
        o17_4: "الفهم العميق للعالم",

        q18: "كيف تتعامل مع التغيير؟",
        o18_1: "أتحداه وأقوده",
        o18_2: "أحتفل به وانغمس فيه",
        o18_3: "أتأقلم ببطء وحذر",
        o18_4: "أحلله وأفهمه أولًا",

        q19: "ما الذي يحفزك للاستمرار؟",
        o19_1: "تحقيق أهدافي الشخصية",
        o19_2: "إسعاد الآخرين ورؤيتهم يبتسمون",
        o19_3: "الحفاظ على الاستقرار والأمان",
        o19_4: "فهم الحقيقة والوصول للكمال",

        q20: "ما هو أسلوبك في حل المشاكل؟",
        o20_1: "أتخذ قرارات سريعة وأتحمل المسؤولية",
        o20_2: "أبحث عن آراء الآخرين وأبني حلول جماعية",
        o20_3: "أتأنى وأفكر في تأثير الحل على الجميع",
        o20_4: "أبحث وأحلل حتى أجد الحل الأمثل"
    },
    en: {
        welcome_title: "Welcome to Chamber of Secrets",
        user_info_title: "Your Personal Information",
        user_info_desc: "Let us know you better to provide accurate analysis",
        age_label: "Age",
        gender_label: "Gender",
        dob_label: "Date of Birth",
        submit_user_info: "Next",
        intro_title: "Get Ready for a Journey of Self-Discovery",
        intro_subtitle: "Analyze Your Personality & Find Your Ideal Partner",
        intro_desc: "You will take a 20-question journey designed to uncover the depths of your personality",
        intro_p1: "We will analyze your personality using the latest psychological theories",
        intro_p2: "And help you discover your ideal partner",
        start_btn: "Start Journey",
        progress: "Progress:",
        next_btn: "Next",
        final_results_btn: "Show Results",
        restart_btn: "Start Over",
        share_btn: "Share Result",
        copy_btn: "Copy Result",
        alert_missing_fields: "Please fill all fields",
        alert_invalid_dob: "Invalid date of birth",
        alert_no_answer: "Please select an answer",
        alert_copied: "Result copied successfully!",
        footer2: "Developed with love ❤️ to help you understand yourself better",
        male: "Male",
        female: "Female",
        other: "Other",
        compatibility_title: "Compatibility Rate",
        partner_traits: "Ideal Partner Traits",
        relationship_advice: "Relationship Advice",
        analysis_intro: "After analyzing your answers, your personality type is:",
        personality_section: "Your Personality Analysis",
        partner_section: "Your Ideal Partner",
        partner_analysis_title: "Detailed Partner Analysis",

        q1: "When you wake up in the morning, what's the first thing on your mind?",
        o1_1: "I'm excited to start my day!",
        o1_2: "Is everything under control?",
        o1_3: "Will I be enough today?",
        o1_4: "I want to understand the meaning of this day",

        q2: "At a new social gathering, what do you do?",
        o2_1: "I start talking to everyone quickly",
        o2_2: "I observe first, then talk to one person",
        o2_3: "I focus on who can benefit me or I can benefit",
        o2_4: "I try to understand others' feelings quickly",

        q3: "What kind of task makes you 'lose yourself'?",
        o3_1: "Fast-paced, time-bound challenges",
        o3_2: "Deep analysis of data or systems",
        o3_3: "Helping someone overcome a crisis",
        o3_4: "Organizing a team to achieve a structured goal",

        q4: "What do you look for most in friendships?",
        o4_1: "Fun and energy",
        o4_2: "Loyalty and stability",
        o4_3: "Depth and meaning",
        o4_4: "Intellectual challenge",

        q5: "How do you handle mistakes?",
        o5_1: "I learn and move on quickly.",
        o5_2: "I analyze what happened in detail.",
        o5_3: "I feel guilty, but I forgive myself.",
        o5_4: "I wonder: does this prove I'm not good enough?",

        q6: "What makes you feel proud?",
        o6_1: "Achieving tangible results.",
        o6_2: "Supporting someone in a crisis.",
        o6_3: "Innovating a new idea.",
        o6_4: "Sticking to duties and responsibilities.",

        q7: "What do you look for in an important decision?",
        o7_1: "Speed and results",
        o7_2: "Inspiration and first impression",
        o7_3: "Team stability and relationships",
        o7_4: "Deep analysis and logic",

        q8: "What do you do when you feel stressed?",
        o8_1: "I confront the situation directly",
        o8_2: "I seek support from others",
        o8_3: "I step back temporarily to rethink",
        o8_4: "I analyze the problem from all angles",

        q9: "What type of books or content do you prefer?",
        o9_1: "Success stories, leadership, influence",
        o9_2: "Novels, philosophy, existential reflections",
        o9_3: "Jokes, funny videos, entertainment",
        o9_4: "Practical guides, steps, techniques",

        q10: "What gives you a sense of meaning?",
        o10_1: "Achieving great accomplishments",
        o10_2: "Serving others",
        o10_3: "Understanding the universe or cosmic system",
        o10_4: "Stability and belonging",

        q11: "How often do you change your mind based on new information?",
        o11_1: "Rarely, I'm confident in my decisions",
        o11_2: "Sometimes, if the argument is strong",
        o11_3: "Often, because I love learning",
        o11_4: "Always, because I hate rigidity",

        q12: "What makes you feel comfortable?",
        o12_1: "Achieving the goal",
        o12_2: "Laughing and interacting",
        o12_3: "Calm and stability",
        o12_4: "Order and complete understanding",

        q13: "What is your motto in life?",
        o13_1: "The result is more important than the method.",
        o13_2: "Life is for fun and experience.",
        o13_3: "Relationships are built with patience and loyalty.",
        o13_4: "Understanding precedes everything.",

        q14: "How do you handle criticism?",
        o14_1: "I challenge it and prove myself",
        o14_2: "I laugh and turn it into a joke",
        o14_3: "I hurt but I learn",
        o14_4: "I analyze it and benefit from it",

        q15: "What type of leadership inspires you?",
        o15_1: "Decisive and fast leadership",
        o15_2: "Inspiring and motivating leadership",
        o15_3: "Supportive and stable leadership",
        o15_4: "Organized and analytical leadership",

        q16: "What makes you feel accomplished?",
        o16_1: "Completing a difficult task",
        o16_2: "Seeing others happy with my work",
        o16_3: "Maintaining balance and harmony",
        o16_4: "Following a precise system",

        q17: "What makes you feel free?",
        o17_1: "Controlling my destiny",
        o17_2: "Expressing myself freely",
        o17_3: "Living in peace with myself",
        o17_4: "Deep understanding of the world",

        q18: "How do you deal with change?",
        o18_1: "I challenge it and lead it",
        o18_2: "I celebrate it and dive into it",
        o18_3: "I adapt slowly and cautiously",
        o18_4: "I analyze and understand it first",

        q19: "What motivates you to keep going?",
        o19_1: "Achieving my personal goals",
        o19_2: "Making others happy and seeing them smile",
        o19_3: "Maintaining stability and safety",
        o19_4: "Understanding truth and reaching perfection",

        q20: "What is your approach to solving problems?",
        o20_1: "I make quick decisions and take responsibility",
        o20_2: "I seek others' opinions and build collective solutions",
        o20_3: "I take my time and consider the impact on everyone",
        o20_4: "I research and analyze until I find the optimal solution"
    }
};

// Questions
const questions = {
    ar: [
        { id: 1, text: translations.ar.q1, options: [
            { text: translations.ar.o1_1, trait: "I", score: 4 },
            { text: translations.ar.o1_2, trait: "C", score: 3 },
            { text: translations.ar.o1_3, trait: "S", score: 2 },
            { text: translations.ar.o1_4, trait: "C", score: 3 }
        ]},
        { id: 2, text: translations.ar.q2, options: [
            { text: translations.ar.o2_1, trait: "I", score: 4 },
            { text: translations.ar.o2_2, trait: "S", score: 4 },
            { text: translations.ar.o2_3, trait: "D", score: 3 },
            { text: translations.ar.o2_4, trait: "S", score: 4 }
        ]},
        { id: 3, text: translations.ar.q3, options: [
            { text: translations.ar.o3_1, trait: "D", score: 4 },
            { text: translations.ar.o3_2, trait: "C", score: 4 },
            { text: translations.ar.o3_3, trait: "S", score: 4 },
            { text: translations.ar.o3_4, trait: "I", score: 3 }
        ]},
        { id: 4, text: translations.ar.q4, options: [
            { text: translations.ar.o4_1, trait: "I", score: 4 },
            { text: translations.ar.o4_2, trait: "S", score: 4 },
            { text: translations.ar.o4_3, trait: "C", score: 4 },
            { text: translations.ar.o4_4, trait: "D", score: 3 }
        ]},
        { id: 5, text: translations.ar.q5, options: [
            { text: translations.ar.o5_1, trait: "D", score: 4 },
            { text: translations.ar.o5_2, trait: "C", score: 4 },
            { text: translations.ar.o5_3, trait: "S", score: 3 },
            { text: translations.ar.o5_4, trait: "S", score: 2 }
        ]},
        { id: 6, text: translations.ar.q6, options: [
            { text: translations.ar.o6_1, trait: "D", score: 4 },
            { text: translations.ar.o6_2, trait: "S", score: 4 },
            { text: translations.ar.o6_3, trait: "I", score: 4 },
            { text: translations.ar.o6_4, trait: "C", score: 3 }
        ]},
        { id: 7, text: translations.ar.q7, options: [
            { text: translations.ar.o7_1, trait: "D", score: 4 },
            { text: translations.ar.o7_2, trait: "I", score: 3 },
            { text: translations.ar.o7_3, trait: "S", score: 4 },
            { text: translations.ar.o7_4, trait: "C", score: 4 }
        ]},
        { id: 8, text: translations.ar.q8, options: [
            { text: translations.ar.o8_1, trait: "D", score: 4 },
            { text: translations.ar.o8_2, trait: "I", score: 3 },
            { text: translations.ar.o8_3, trait: "S", score: 3 },
            { text: translations.ar.o8_4, trait: "C", score: 4 }
        ]},
        { id: 9, text: translations.ar.q9, options: [
            { text: translations.ar.o9_1, trait: "D", score: 4 },
            { text: translations.ar.o9_2, trait: "C", score: 4 },
            { text: translations.ar.o9_3, trait: "I", score: 3 },
            { text: translations.ar.o9_4, trait: "S", score: 3 }
        ]},
        { id: 10, text: translations.ar.q10, options: [
            { text: translations.ar.o10_1, trait: "D", score: 4 },
            { text: translations.ar.o10_2, trait: "S", score: 4 },
            { text: translations.ar.o10_3, trait: "C", score: 4 },
            { text: translations.ar.o10_4, trait: "S", score: 3 }
        ]},
        { id: 11, text: translations.ar.q11, options: [
            { text: translations.ar.o11_1, trait: "D", score: 4 },
            { text: translations.ar.o11_2, trait: "C", score: 4 },
            { text: translations.ar.o11_3, trait: "I", score: 4 },
            { text: translations.ar.o11_4, trait: "I", score: 3 }
        ]},
        { id: 12, text: translations.ar.q12, options: [
            { text: translations.ar.o12_1, trait: "D", score: 4 },
            { text: translations.ar.o12_2, trait: "I", score: 4 },
            { text: translations.ar.o12_3, trait: "S", score: 4 },
            { text: translations.ar.o12_4, trait: "C", score: 4 }
        ]},
        { id: 13, text: translations.ar.q13, options: [
            { text: translations.ar.o13_1, trait: "D", score: 4 },
            { text: translations.ar.o13_2, trait: "I", score: 4 },
            { text: translations.ar.o13_3, trait: "S", score: 4 },
            { text: translations.ar.o13_4, trait: "C", score: 4 }
        ]},
        { id: 14, text: translations.ar.q14, options: [
            { text: translations.ar.o14_1, trait: "D", score: 4 },
            { text: translations.ar.o14_2, trait: "I", score: 3 },
            { text: translations.ar.o14_3, trait: "S", score: 3 },
            { text: translations.ar.o14_4, trait: "C", score: 4 }
        ]},
        { id: 15, text: translations.ar.q15, options: [
            { text: translations.ar.o15_1, trait: "D", score: 3 },
            { text: translations.ar.o15_2, trait: "I", score: 3 },
            { text: translations.ar.o15_3, trait: "S", score: 3 },
            { text: translations.ar.o15_4, trait: "C", score: 3 }
        ]},
        { id: 16, text: translations.ar.q16, options: [
            { text: translations.ar.o16_1, trait: "D", score: 4 },
            { text: translations.ar.o16_2, trait: "I", score: 4 },
            { text: translations.ar.o16_3, trait: "S", score: 4 },
            { text: translations.ar.o16_4, trait: "C", score: 4 }
        ]},
        { id: 17, text: translations.ar.q17, options: [
            { text: translations.ar.o17_1, trait: "D", score: 4 },
            { text: translations.ar.o17_2, trait: "I", score: 4 },
            { text: translations.ar.o17_3, trait: "S", score: 4 },
            { text: translations.ar.o17_4, trait: "C", score: 4 }
        ]},
        { id: 18, text: translations.ar.q18, options: [
            { text: translations.ar.o18_1, trait: "D", score: 4 },
            { text: translations.ar.o18_2, trait: "I", score: 4 },
            { text: translations.ar.o18_3, trait: "S", score: 3 },
            { text: translations.ar.o18_4, trait: "C", score: 4 }
        ]},
        { id: 19, text: translations.ar.q19, options: [
            { text: translations.ar.o19_1, trait: "D", score: 4 },
            { text: translations.ar.o19_2, trait: "I", score: 4 },
            { text: translations.ar.o19_3, trait: "S", score: 4 },
            { text: translations.ar.o19_4, trait: "C", score: 4 }
        ]},
        { id: 20, text: translations.ar.q20, options: [
            { text: translations.ar.o20_1, trait: "D", score: 4 },
            { text: translations.ar.o20_2, trait: "I", score: 4 },
            { text: translations.ar.o20_3, trait: "S", score: 4 },
            { text: translations.ar.o20_4, trait: "C", score: 4 }
        ]}
    ],
    en: [
        { id: 1, text: translations.en.q1, options: [
            { text: translations.en.o1_1, trait: "I", score: 4 },
            { text: translations.en.o1_2, trait: "C", score: 3 },
            { text: translations.en.o1_3, trait: "S", score: 2 },
            { text: translations.en.o1_4, trait: "C", score: 3 }
        ]},
        { id: 2, text: translations.en.q2, options: [
            { text: translations.en.o2_1, trait: "I", score: 4 },
            { text: translations.en.o2_2, trait: "S", score: 4 },
            { text: translations.en.o2_3, trait: "D", score: 3 },
            { text: translations.en.o2_4, trait: "S", score: 4 }
        ]},
        { id: 3, text: translations.en.q3, options: [
            { text: translations.en.o3_1, trait: "D", score: 4 },
            { text: translations.en.o3_2, trait: "C", score: 4 },
            { text: translations.en.o3_3, trait: "S", score: 4 },
            { text: translations.en.o3_4, trait: "I", score: 3 }
        ]},
        { id: 4, text: translations.en.q4, options: [
            { text: translations.en.o4_1, trait: "I", score: 4 },
            { text: translations.en.o4_2, trait: "S", score: 4 },
            { text: translations.en.o4_3, trait: "C", score: 4 },
            { text: translations.en.o4_4, trait: "D", score: 3 }
        ]},
        { id: 5, text: translations.en.q5, options: [
            { text: translations.en.o5_1, trait: "D", score: 4 },
            { text: translations.en.o5_2, trait: "C", score: 4 },
            { text: translations.en.o5_3, trait: "S", score: 3 },
            { text: translations.en.o5_4, trait: "S", score: 2 }
        ]},
        { id: 6, text: translations.en.q6, options: [
            { text: translations.en.o6_1, trait: "D", score: 4 },
            { text: translations.en.o6_2, trait: "S", score: 4 },
            { text: translations.en.o6_3, trait: "I", score: 4 },
            { text: translations.en.o6_4, trait: "C", score: 3 }
        ]},
        { id: 7, text: translations.en.q7, options: [
            { text: translations.en.o7_1, trait: "D", score: 4 },
            { text: translations.en.o7_2, trait: "I", score: 3 },
            { text: translations.en.o7_3, trait: "S", score: 4 },
            { text: translations.en.o7_4, trait: "C", score: 4 }
        ]},
        { id: 8, text: translations.en.q8, options: [
            { text: translations.en.o8_1, trait: "D", score: 4 },
            { text: translations.en.o8_2, trait: "I", score: 3 },
            { text: translations.en.o8_3, trait: "S", score: 3 },
            { text: translations.en.o8_4, trait: "C", score: 4 }
        ]},
        { id: 9, text: translations.en.q9, options: [
            { text: translations.en.o9_1, trait: "D", score: 4 },
            { text: translations.en.o9_2, trait: "C", score: 4 },
            { text: translations.en.o9_3, trait: "I", score: 3 },
            { text: translations.en.o9_4, trait: "S", score: 3 }
        ]},
        { id: 10, text: translations.en.q10, options: [
            { text: translations.en.o10_1, trait: "D", score: 4 },
            { text: translations.en.o10_2, trait: "S", score: 4 },
            { text: translations.en.o10_3, trait: "C", score: 4 },
            { text: translations.en.o10_4, trait: "S", score: 3 }
        ]},
        { id: 11, text: translations.en.q11, options: [
            { text: translations.en.o11_1, trait: "D", score: 4 },
            { text: translations.en.o11_2, trait: "C", score: 4 },
            { text: translations.en.o11_3, trait: "I", score: 4 },
            { text: translations.en.o11_4, trait: "I", score: 3 }
        ]},
        { id: 12, text: translations.en.q12, options: [
            { text: translations.en.o12_1, trait: "D", score: 4 },
            { text: translations.en.o12_2, trait: "I", score: 4 },
            { text: translations.en.o12_3, trait: "S", score: 4 },
            { text: translations.en.o12_4, trait: "C", score: 4 }
        ]},
        { id: 13, text: translations.en.q13, options: [
            { text: translations.en.o13_1, trait: "D", score: 4 },
            { text: translations.en.o13_2, trait: "I", score: 4 },
            { text: translations.en.o13_3, trait: "S", score: 4 },
            { text: translations.en.o13_4, trait: "C", score: 4 }
        ]},
        { id: 14, text: translations.en.q14, options: [
            { text: translations.en.o14_1, trait: "D", score: 4 },
            { text: translations.en.o14_2, trait: "I", score: 3 },
            { text: translations.en.o14_3, trait: "S", score: 3 },
            { text: translations.en.o14_4, trait: "C", score: 4 }
        ]},
        { id: 15, text: translations.en.q15, options: [
            { text: translations.en.o15_1, trait: "D", score: 3 },
            { text: translations.en.o15_2, trait: "I", score: 3 },
            { text: translations.en.o15_3, trait: "S", score: 3 },
            { text: translations.en.o15_4, trait: "C", score: 3 }
        ]},
        { id: 16, text: translations.en.q16, options: [
            { text: translations.en.o16_1, trait: "D", score: 4 },
            { text: translations.en.o16_2, trait: "I", score: 4 },
            { text: translations.en.o16_3, trait: "S", score: 4 },
            { text: translations.en.o16_4, trait: "C", score: 4 }
        ]},
        { id: 17, text: translations.en.q17, options: [
            { text: translations.en.o17_1, trait: "D", score: 4 },
            { text: translations.en.o17_2, trait: "I", score: 4 },
            { text: translations.en.o17_3, trait: "S", score: 4 },
            { text: translations.en.o17_4, trait: "C", score: 4 }
        ]},
        { id: 18, text: translations.en.q18, options: [
            { text: translations.en.o18_1, trait: "D", score: 4 },
            { text: translations.en.o18_2, trait: "I", score: 4 },
            { text: translations.en.o18_3, trait: "S", score: 3 },
            { text: translations.en.o18_4, trait: "C", score: 4 }
        ]},
        { id: 19, text: translations.en.q19, options: [
            { text: translations.en.o19_1, trait: "D", score: 4 },
            { text: translations.en.o19_2, trait: "I", score: 4 },
            { text: translations.en.o19_3, trait: "S", score: 4 },
            { text: translations.en.o19_4, trait: "C", score: 4 }
        ]},
        { id: 20, text: translations.en.q20, options: [
            { text: translations.en.o20_1, trait: "D", score: 4 },
            { text: translations.en.o20_2, trait: "I", score: 4 },
            { text: translations.en.o20_3, trait: "S", score: 4 },
            { text: translations.en.o20_4, trait: "C", score: 4 }
        ]}
    ]
};

// Personality Types
const personalityTypes = {
    ar: {
        D: {
            name: 'القائد المهيمن (الأحمر)',
            description: `أنت شخصية قيادية بطبيعتك، تمتلك إرادة قوية وتحب التحكم في الأمور. لا تهاب التحديات، وتميل إلى اتخاذ القرارات بسرعة وثقة. أنت موجه نحو النتائج، وتحب أن ترى تقدماً ملموساً. قد تبدو أحياناً حازماً أكثر من اللازم، لكن دافعك هو إحداث تأثير حقيقي.`
        },
        I: {
            name: 'الشخصية المؤثرة (الأصفر)',
            description: `أنت شخصية اجتماعية، مليئة بالحيوية والتفاؤل. تمتلك مهارات تواصل استثنائية، وتحب أن تكون محط الأنظار. تُلهم الآخرين بسهولة، وتحب المغامرة والتجارب الجديدة. قد تهمل التفاصيل أحيانًا، لكن طاقتك الإيجابية تُحدث فرقًا كبيرًا.`
        },
        S: {
            name: 'الشخصية المستقرة (الأخضر)',
            description: `أنت شخصية هادئة، ودودة، ومستقرة. تُقدّر العلاقات العميقة والولاء. تُعتبر مستمعًا جيدًا، وتدعم من حولك بثبات. تكره التغيير المفاجئ، لكنك تحافظ على التوازن والانسجام في كل الظروف.`
        },
        C: {
            name: 'الشخصية الواعية (الأزرق)',
            description: `أنت شخصية تحليلية، دقيقة، ومنظمة. تهتم بالجودة والدقة في كل ما تفعله. تُفضل اتخاذ قرارات مدروسة بناءً على البيانات. قد تبدو باردة أحيانًا، لكنك تسعى دائمًا للوصول إلى الكمال.`
        }
    },
    en: {
        D: {
            name: 'The Dominant Leader (Red)',
            description: `You are a natural-born leader, strong-willed and love taking control. You don't fear challenges and tend to make quick, confident decisions. Goal-oriented and results-driven, you thrive on tangible progress. You may seem too assertive at times, but your motivation is to make a real impact.`
        },
        I: {
            name: 'The Influencer (Yellow)',
            description: `You are social, energetic, and optimistic. You have exceptional communication skills and enjoy being in the spotlight. You easily inspire others and love adventure and new experiences. You may overlook details sometimes, but your positive energy makes a big difference.`
        },
        S: {
            name: 'The Steady Supporter (Green)',
            description: `You are calm, friendly, and stable. You value deep relationships and loyalty. A great listener, you support those around you consistently. You dislike sudden change, but you maintain balance and harmony in all circumstances.`
        },
        C: {
            name: 'The Conscientious Thinker (Blue)',
            description: `You are analytical, precise, and organized. You care about quality and accuracy in everything you do. You prefer making well-thought decisions based on data. You may seem reserved at times, but you always strive for excellence.`
        }
    }
};

// Strengths & Growth Areas
const strengths = {
    ar: {
        D: ['اتخاذ قرارات سريعة', 'القيادة الحازمة', 'التركيز على النتائج', 'الثقة بالنفس'],
        I: ['التواصل والتأثير', 'تحفيز الآخرين', 'المرونة العالية', 'بناء العلاقات'],
        S: ['الاستماع الجيد', 'الوفاء والالتزام', 'تهدئة المواقف', 'العمل الجماعي'],
        C: ['الدقة والانتباه', 'التفكير المنطقي', 'الالتزام بالجودة', 'التنظيم الممتاز']
    },
    en: {
        D: ['Quick decision-making', 'Leading teams', 'Focus on results', 'Self-confidence'],
        I: ['Communication & influence', 'Motivating others', 'High flexibility', 'Building relationships'],
        S: ['Good listening', 'Loyalty & commitment', 'Calming situations', 'Teamwork'],
        C: ['Precision & attention', 'Logical thinking', 'Commitment to quality', 'Excellent organization']
    }
};

const growthAreas = {
    ar: {
        D: ['الاستماع أكثر للآخرين', 'منح مساحة للقرارات', 'التعامل بلطف أكبر', 'الاعتراف بالمشاعر'],
        I: ['التركيز على المهام', 'اتباع خطة منظمة', 'التعامل مع النقد', 'تطوير الصبر'],
        S: ['التحدث عن احتياجاتك', 'اتخاذ موقف حاسم', 'الانفتاح على التغيير', 'الاعتناء بنفسك أولاً'],
        C: ['التحدث عن المشاعر', 'اتخاذ قرارات أسرع', 'التعامل مع الأخطاء', 'الثقة بالآخرين']
    },
    en: {
        D: ['Listen more to others', 'Give space for decisions', 'Be more gentle', 'Acknowledge feelings'],
        I: ['Focus on tasks', 'Follow an organized plan', 'Handle criticism', 'Develop patience'],
        S: ['Speak about your needs', 'Take a decisive stance', 'Open up to change', 'Take care of yourself first'],
        C: ['Talk about feelings', 'Make faster decisions', 'Deal with mistakes', 'Trust others']
    }
};

// Zodiac Compatibility
const zodiacCompatibility = {
    ar: {
        'الحمل': ['الأسد', 'القوس'],
        'الثور': ['العذراء', 'الجدي'],
        'الجوزاء': ['الميزان', 'الدلو'],
        'السرطان': ['العقرب', 'الحوت'],
        'الأسد': ['الحمل', 'القوس'],
        'العذراء': ['الثور', 'الجدي'],
        'الميزان': ['الجوزاء', 'الدلو'],
        'العقرب': ['السرطان', 'الحوت'],
        'القوس': ['الحمل', 'الأسد'],
        'الجدي': ['الثور', 'العذراء'],
        'الدلو': ['الجوزاء', 'الميزان'],
        'الحوت': ['السرطان', 'العقرب']
    },
    en: {
        'Aries': ['Leo', 'Sagittarius'],
        'Taurus': ['Virgo', 'Capricorn'],
        'Gemini': ['Libra', 'Aquarius'],
        'Cancer': ['Scorpio', 'Pisces'],
        'Leo': ['Aries', 'Sagittarius'],
        'Virgo': ['Taurus', 'Capricorn'],
        'Libra': ['Gemini', 'Aquarius'],
        'Scorpio': ['Cancer', 'Pisces'],
        'Sagittarius': ['Aries', 'Leo'],
        'Capricorn': ['Taurus', 'Virgo'],
        'Aquarius': ['Gemini', 'Libra'],
        'Pisces': ['Cancer', 'Scorpio']
    }
};

// Partner Analysis
const partnerAnalysisData = {
    ar: {
        D: {
            ideal: 'I',
            name: 'الشخصية المؤثرة',
            desc: 'تحتاج الشخصية القائدة لشريك يجلب الحيوية والتفاؤل.',
            traits: ['مرح', 'اجتماعي', 'متفائل', 'مبدع'],
            advice: ['كن صبوراً', 'شاركه بالتفاصيل', 'أظهر الدعم العاطفي']
        },
        I: {
            ideal: 'S',
            name: 'الشخصية المستقرة',
            desc: 'تحتاج الشخصية المؤثرة لشريك يوفر الاستقرار والدعم العاطفي.',
            traits: ['هادئ', 'وفي', 'متفهم', 'مستقر'],
            advice: ['كن متسامحًا', 'شجعه على التعبير', 'امنحه الأمان']
        },
        S: {
            ideal: 'I',
            name: 'الشخصية المؤثرة',
            desc: 'تحتاج الشخصية المستقرة لشريك يجلب الحيوية والطاقة.',
            traits: ['نشيط', 'مرح', 'اجتماعي', 'متفائل'],
            advice: ['كن صبوراً', 'شاركه اجتماعياً', 'أظهر التقدير']
        },
        C: {
            ideal: 'D',
            name: 'القائد المهيمن',
            desc: 'تحتاج الشخصية الواعية لشريك يقدر دقتها ويوفر الدعم.',
            traits: ['حاسم', 'يقدر الجودة', 'سريع القرار', 'يوفر الحماية'],
            advice: ['احترم حاجته للتفكير', 'قدر التفاصيل', 'كن واضحاً']
        }
    },
    en: {
        D: {
            ideal: 'I',
            name: 'The Influencer',
            desc: 'The dominant leader needs a partner who brings energy and optimism.',
            traits: ['Fun', 'Social', 'Optimistic', 'Creative'],
            advice: ['Be patient', 'Share details', 'Show emotional support']
        },
        I: {
            ideal: 'S',
            name: 'The Steady Supporter',
            desc: 'The influencer needs a partner who provides stability and emotional support.',
            traits: ['Calm', 'Loyal', 'Understanding', 'Stable'],
            advice: ['Be tolerant', 'Encourage expression', 'Provide security']
        },
        S: {
            ideal: 'I',
            name: 'The Influencer',
            desc: 'The steady supporter needs a partner who brings vitality and energy.',
            traits: ['Energetic', 'Fun', 'Social', 'Optimistic'],
            advice: ['Be patient', 'Include them socially', 'Show appreciation']
        },
        C: {
            ideal: 'D',
            name: 'The Dominant Leader',
            desc: 'The conscientious thinker needs a partner who values precision and offers support.',
            traits: ['Decisive', 'Values quality', 'Quick decision-maker', 'Provides protection'],
            advice: ['Respect their thinking time', 'Appreciate details', 'Be clear']
        }
    }
};

// ===== UTILITY FUNCTIONS =====
function calculateAge(birthDate) {
    const today = new Date();
    const birth = new Date(birthDate);
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
    }
    return age;
}

function getZodiacSign(birthDate) {
    const date = new Date(birthDate);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const formattedMonth = month < 10 ? `0${month}` : `${month}`;
    const formattedDay = day < 10 ? `0${day}` : `${day}`;
    const dateStr = `${formattedMonth}-${formattedDay}`;

    const signs = zodiacSignsData[state.lang];
    for (let sign of signs) {
        if (dateStr >= sign.start && dateStr <= sign.end) return sign.name;
        if (sign.start === '12-22' && dateStr >= '12-22') return sign.name;
        if (sign.end === '01-19' && dateStr <= '01-19') return sign.name;
    }
    return '';
}

function initializeCounters() {
    const visitorCount = parseInt(localStorage.getItem('visitorCount')) || 1342;
    const analysisCount = parseInt(localStorage.getItem('analysisCount')) || 217;
    localStorage.setItem('visitorCount', visitorCount);
    localStorage.setItem('analysisCount', analysisCount);
}

function getVisitorCount() {
    return parseInt(localStorage.getItem('visitorCount') || '1342').toLocaleString(state.lang === 'ar' ? 'ar-EG' : 'en-US');
}

function getAnalysisCount() {
    return parseInt(localStorage.getItem('analysisCount') || '217').toLocaleString(state.lang === 'ar' ? 'ar-EG' : 'en-US');
}

// ===== ANALYSIS FUNCTIONS =====
function analyzePersonality() {
    const scores = { D: 0, I: 0, S: 0, C: 0 };
    state.userAnswers.forEach(answerIndex => {
        const question = questions[state.lang][state.userAnswers.indexOf(answerIndex)];
        const option = question.options[answerIndex];
        if (option && scores[option.trait] !== undefined) {
            scores[option.trait] += option.score;
        }
    });

    const primaryTrait = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
    return { scores, primaryTrait };
}

function generatePartnerAnalysis(trait, zodiac) {
    const data = partnerAnalysisData[state.lang][trait];
    const compatibleSigns = zodiacCompatibility[state.lang][zodiac] || [];
    return {
        ...data,
        zodiacMatches: compatibleSigns
    };
}

// ===== RENDER FUNCTIONS =====
function renderUserInfo() {
    const t = translations[state.lang];
    return `
    <div class="glass-card rounded-xl p-8 max-w-3xl mx-auto text-center">
        <h2 class="text-3xl font-bold mb-4">${t.user_info_title}</h2>
        <p class="text-gray-300 mb-6">${t.user_info_desc}</p>
        <div class="space-y-6">
            <div>
                <label class="block text-left mb-2">${t.age_label}</label>
                <input type="number" id="age" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600" />
            </div>
            <div>
                <label class="block text-left mb-2">${t.gender_label}</label>
                <select id="gender" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600">
                    <option value="male">${t.male}</option>
                    <option value="female">${t.female}</option>
                    <option value="other">${t.other}</option>
                </select>
            </div>
            <div>
                <label class="block text-left mb-2">${t.dob_label}</label>
                <input type="date" id="dob" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600" />
            </div>
            <button onclick="submitUserInfo()" class="btn-primary">${t.submit_user_info}</button>
        </div>
    </div>`;
}

function renderIntro() {
    const t = translations[state.lang];
    return `
    <div class="animate-fade-in text-center">
        <div class="glass-card rounded-xl p-8 max-w-3xl mx-auto">
            <h1 class="text-4xl font-bold mb-4">${t.intro_title}</h1>
            <p class="text-xl text-gray-300 mb-6">${t.intro_subtitle}</p>
            <p class="text-gray-400 mb-4">${t.intro_desc}</p>
            <div class="text-left text-gray-300 space-y-2 mb-6">
                <p>• ${t.intro_p1}</p>
                <p>• ${t.intro_p2}</p>
            </div>
            <button onclick="startQuiz()" class="btn-primary">${t.start_btn}</button>
        </div>
    </div>`;
}

function renderQuiz() {
    const t = translations[state.lang];
    const q = questions[state.lang][state.currentQ];
    const progress = ((state.currentQ) / questions[state.lang].length * 100).toFixed(0);

    let optionsHTML = '';
    q.options.forEach((opt, index) => {
        optionsHTML += `<div class="option-item" onclick="selectAnswer(${index})">${opt.text}</div>`;
    });

    return `
    <div class="animate-fade-in">
        <div class="progress-bar">
            <div class="progress-fill" style="width:${progress}%"></div>
        </div>
        <div class="text-center mb-6">
            <p class="text-gray-400">${t.progress} ${state.currentQ + 1}/${questions[state.lang].length}</p>
        </div>
        <div class="glass-card rounded-xl p-8 max-w-3xl mx-auto">
            <h2 class="text-2xl font-bold mb-6">${q.text}</h2>
            <div class="space-y-4">${optionsHTML}</div>
            <button onclick="nextQuestion()" class="btn-primary mt-8">
                ${state.currentQ === questions[state.lang].length - 1 ? t.final_results_btn : t.next_btn}
            </button>
        </div>
    </div>`;
}

function renderResults() {
    const { scores, primaryTrait } = analyzePersonality();
    const t = translations[state.lang];
    const pType = personalityTypes[state.lang][primaryTrait];
    const zodiacSign = getZodiacSign(state.userData.dob);
    const partnerAnalysis = generatePartnerAnalysis(primaryTrait, zodiacSign);

    state.zodiacSign = zodiacSign;
    state.partnerAnalysis = partnerAnalysis;

    const resultSummary = `
    <div class="animate-fade-in">
        <div class="glass-card rounded-xl p-8 max-w-4xl mx-auto">
            <h2 class="text-3xl font-bold mb-6">${t.personality_section}</h2>
            <p class="text-gray-300 mb-6">${t.analysis_intro}</p>
            <div class="bg-gradient-to-r from-gray-700 to-gray-900 p-6 rounded-lg mb-8">
                <h3 class="text-2xl font-bold mb-2">${pType.name}</h3>
                <p class="text-gray-200">${pType.description}</p>
            </div>

            <h2 class="text-3xl font-bold mb-6">${t.partner_section}</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-blue-900/30 p-6 rounded-lg">
                    <h3 class="text-xl font-bold mb-2">${t.partner_analysis_title}</h3>
                    <p><strong>${t.compatibility_title}:</strong> ${partnerAnalysis.zodiacMatches.join(', ')}</p>
                    <p><strong>${t.partner_traits}:</strong> ${partnerAnalysis.traits.join(', ')}</p>
                    <p><strong>${t.relationship_advice}:</strong> ${partnerAnalysis.advice.join(', ')}</p>
                </div>
                <div class="bg-green-900/30 p-6 rounded-lg">
                    <h3 class="text-xl font-bold mb-2">نصائح النمو</h3>
                    <ul class="list-disc list-inside">${growthAreas[state.lang][primaryTrait].map(g => `<li>${g}</li>`).join('')}</ul>
                </div>
            </div>

            <div class="mt-8 text-center">
                <button onclick="restartQuiz()" class="btn-secondary mr-4">${t.restart_btn}</button>
                <button onclick="copyResult()" class="btn-primary">${t.copy_btn}</button>
            </div>
        </div>
    </div>`;

    state.resultText = resultSummary;
    return resultSummary;
}

// ===== EVENT HANDLERS =====
function submitUserInfo() {
    const age = document.getElementById('age').value;
    const gender = document.getElementById('gender').value;
    const dob = document.getElementById('dob').value;
    const t = translations[state.lang];

    if (!age || !gender || !dob) {
        alert(t.alert_missing_fields);
        return;
    }

    if (new Date(dob) > new Date()) {
        alert(t.alert_invalid_dob);
        return;
    }

    state.userData = { age, gender, dob };
    render();
}

function startQuiz() {
    state.currentQ = 0;
    state.userAnswers = Array(questions[state.lang].length).fill(null);
    render();
}

function selectAnswer(index) {
    state.userAnswers[state.currentQ] = index;
    document.querySelectorAll('.option-item').forEach(el => el.classList.remove('selected'));
    event.target.classList.add('selected');
}

function nextQuestion() {
    if (state.userAnswers[state.currentQ] === null) {
        const t = translations[state.lang];
        alert(t.alert_no_answer);
        return;
    }

    if (state.currentQ < questions[state.lang].length - 1) {
        state.currentQ++;
        render();
    } else {
        renderResults();
    }
}

function restartQuiz() {
    state.currentQ = 0;
    state.userAnswers = [];
    state.personalityScore = { D: 0, I: 0, S: 0, C: 0 };
    state.userData = { age: null, gender: '', dob: '' };
    state.zodiacSign = '';
    state.partnerAnalysis = null;
    render();
}

function copyResult() {
    navigator.clipboard.writeText(state.resultText || "نتائج التحليل").then(() => {
        const t = translations[state.lang];
        alert(t.alert_copied);
    });
}

// ===== INIT =====
function render() {
    const app = document.getElementById('app');
    if (state.userData.age === null) {
        app.innerHTML = renderUserInfo();
    } else if (state.currentQ === 0 && state.userAnswers.length === 0) {
        app.innerHTML = renderIntro();
    } else {
        app.innerHTML = renderQuiz();
    }
}

document.addEventListener('DOMContentLoaded', () => {
    initializeCounters();
    render();
});
