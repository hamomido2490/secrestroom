<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>غرفة الأسرار | اكتشف شخصيتك</title>

  <!-- تحميل Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- خطوط Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet" />

  <!-- Font Awesome لعرض الأيقونات -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- أنماط مخصصة -->
  <style>
    /* أنماط عامة */
    body {
      font-family: 'Cairo', 'Inter', sans-serif;
      background: linear-gradient(135deg, #1e293b, #0f172a);
      color: #e2e8f0;
      min-height: 100vh;
    }

    /* أنماط الزجاج (Glassmorphism) */
    .glass-card {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    /* تدرج نصي مميز */
    .gradient-text {
      background: linear-gradient(45deg, #fbbf24, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: bold;
    }

    /* زر رئيسي */
    .btn-primary {
      background: linear-gradient(45deg, #ec4899, #fbbf24);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s ease;
      margin: 10px;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
    }

    /* زر ثانوي */
    .btn-secondary {
      background: transparent;
      color: #cbd5e1;
      border: 1px solid #cbd5e1;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 10px;
    }
    .btn-secondary:hover {
      background: rgba(203, 213, 225, 0.1);
    }

    /* شريط التقدم */
    .progress-container {
      margin: 16px 0 24px;
      text-align: left;
    }
    .progress-container span {
      display: block;
      height: 8px;
      background: #334155;
      border-radius: 999px;
      overflow: hidden;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981, #3b82f6);
      border-radius: 999px;
      transition: width 0.5s ease;
    }

    /* بطاقات الإحصائيات */
    .stats-card {
      background: rgba(30, 41, 59, 0.8);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      transition: transform 0.3s ease;
      margin: 10px;
    }
    .stats-card:hover {
      transform: translateY(-5px);
    }
    .stats-number {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .stats-label {
      color: #94a3b8;
      font-size: 0.9rem;
    }

    /* أنماط التعليقات */
    .feedback-item {
      background: rgba(30, 41, 59, 0.6);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .feedback-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .feedback-rating {
      color: #fbbf24;
    }
    .feedback-date {
      color: #94a3b8;
      font-size: 0.8rem;
    }
    .feedback-comment {
      color: #e2e8f0;
      font-size: 0.9rem;
    }

    /* مقياس التوافق */
    .compatibility-meter {
      height: 20px;
      background: #334155;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }
    .compatibility-fill {
      height: 100%;
      background: linear-gradient(90deg, #10b981, #34d399);
      width: 0;
      transition: width 1.5s ease;
    }

    /* الشخصيات المشابهة */
    .similar-personality {
      border-radius: 12px;
      background: rgba(30, 41, 59, 0.6);
      margin-bottom: 15px;
      transition: transform 0.3s ease;
      text-align: center;
    }
    .similar-personality:hover {
      transform: translateY(-5px);
    }
    .similar-personality img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin-bottom: 10px;
      object-fit: cover;
    }

    /* لوحة الإعدادات */
    .settings-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .settings-panel {
      background: rgba(30, 41, 59, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 1rem;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      color: white;
      max-height: 90vh;
      overflow-y: auto;
    }
    .toggle-switch {
      position: relative;
      width: 50px;
      height: 24px;
      background: #334155;
      border-radius: 999px;
      cursor: pointer;
    }
    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s ease;
    }
    .toggle-switch.checked {
      background: #3b82f6;
    }
    .toggle-switch.checked::after {
      transform: translateX(26px);
    }

    /* شريط التحميل */
    .loading-spinner {
      display: inline-block;
      width: 3rem;
      height: 3rem;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fbbf24;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* حاوية المخططات */
    .chart-container {
      position: relative;
      height: 300px;
      margin: 20px 0;
    }

    /* أيقونة البرج */
    .zodiac-icon {
      font-size: 2rem;
      margin-bottom: 8px;
    }

    /* العناصر العامة */
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .text-left { text-align: left; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .mb-8 { margin-bottom: 2rem; }
    .mt-6 { margin-top: 1.5rem; }
    .mt-8 { margin-top: 2rem; }
    .mt-16 { margin-top: 4rem; }
    .p-3 { padding: 0.75rem; }
    .p-6 { padding: 1.5rem; }
    .p-8 { padding: 2rem; }
    .rounded-lg { border-radius: 0.5rem; }
    .rounded-xl { border-radius: 0.75rem; }
    .flex { display: flex; }
    .grid { display: grid; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .justify-center { justify-content: center; }
    .w-full { width: 100%; }
    .max-w-3xl { max-width: 48rem; }
    .max-w-4xl { max-width: 56rem; }
    .relative { position: relative; }
    .fixed { position: fixed; }
    .top-4 { top: 1rem; }
    .left-4 { left: 1rem; }
    .z-50 { z-index: 50; }
    .space-x-2 > * + * { margin-left: 0.5rem; }
    .rounded-full { border-radius: 9999px; }
    .bg-gray-800 { background-color: #1f2937; }
    .hover\:bg-gray-700:hover { background-color: #374151; }
    .text-white { color: white; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
  </style>
</head>

<body class="min-h-screen text-gray-200">
  <div id="app" class="container mx-auto px-4 py-8"></div>

  <!-- لوحة إعدادات الإعلانات -->
  <div id="settingsOverlay" class="settings-overlay">
    <div class="settings-panel">
      <h2 class="text-2xl font-bold mb-4">إعدادات الإعلانات</h2>
      <div class="mb-4">
        <label class="flex items-center">
          <span class="mr-3">إعلان علوي</span>
          <div id="topAdToggle" class="toggle-switch"></div>
        </label>
        <textarea id="topAdCode" class="w-full mt-2 p-2 bg-gray-800 rounded" placeholder="ضع كود الإعلان هنا..."></textarea>
      </div>
      <div class="mb-4">
        <label class="flex items-center">
          <span class="mr-3">إعلان جانبي</span>
          <div id="sideAdToggle" class="toggle-switch"></div>
        </label>
        <textarea id="sideAdCode" class="w-full mt-2 p-2 bg-gray-800 rounded" placeholder="ضع كود الإعلان هنا..."></textarea>
      </div>
      <div class="mb-4">
        <label class="flex items-center">
          <span class="mr-3">إعلان سفلي</span>
          <div id="bottomAdToggle" class="toggle-switch"></div>
        </label>
        <textarea id="bottomAdCode" class="w-full mt-2 p-2 bg-gray-800 rounded" placeholder="ضع كود الإعلان هنا..."></textarea>
      </div>
      <button id="saveSettings" class="btn-primary w-full">حفظ الإعدادات</button>
      <button id="closeSettings" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded mt-2">إغلاق</button>
    </div>
  </div>

  <!-- رسالة إشعار -->
  <div id="toast" class="fixed top-4 left-4 bg-green-600 text-white px-4 py-2 rounded-lg z-50 opacity-0 transition-opacity duration-300"></div>

  <!-- مكتبة Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- الكود الرئيسي -->
  <script>
    // ===== الحالة العامة للتطبيق =====
    const state = {
      currentQ: 0,
      userAnswers: [],
      userData: { gender: '', dob: '' },
      lang: 'ar',
      page: 'userInfo',
      resultText: '',
      resultData: null,
      historyIndex: null
    };

    // ===== إعدادات الإعلانات الافتراضية =====
    const defaultAdSettings = {
      top: false,
      side: false,
      bottom: false,
      topCode: '',
      sideCode: '',
      bottomCode: ''
    };

    function saveAdSettings(settings) {
      try {
        localStorage.setItem('adSettings', JSON.stringify(settings));
        updateAdStatus();
      } catch (error) {
        console.error('Error saving ad settings:', error);
      }
    }

    function getAdSettings() {
      try {
        const saved = localStorage.getItem('adSettings');
        return saved ? JSON.parse(saved) : defaultAdSettings;
      } catch (error) {
        console.error('Error loading ad settings:', error);
        return defaultAdSettings;
      }
    }

    function updateAdStatus() {
      const settings = getAdSettings();
      const topStatus = document.getElementById('topStatus');
      const sideStatus = document.getElementById('sideStatus');
      const bottomStatus = document.getElementById('bottomStatus');

      if (topStatus) {
        topStatus.textContent = settings.top ? 'مفعل' : 'معطل';
        topStatus.className = settings.top ? 'text-lg font-bold text-green-400' : 'text-lg font-bold text-red-400';
      }
      if (sideStatus) {
        sideStatus.textContent = settings.side ? 'مفعل' : 'معطل';
        sideStatus.className = settings.side ? 'text-lg font-bold text-green-400' : 'text-lg font-bold text-red-400';
      }
      if (bottomStatus) {
        bottomStatus.textContent = settings.bottom ? 'مفعل' : 'معطل';
        bottomStatus.className = settings.bottom ? 'text-lg font-bold text-green-400' : 'text-lg font-bold text-red-400';
      }
    }

    // ===== توليد الإعلانات =====
    function renderAds() {
      try {
        const settings = getAdSettings();
        const adPositions = ['top', 'side', 'bottom'];
        const ads = {};

        adPositions.forEach(position => {
          if (settings[position] && settings[`${position}Code`]) {
            const adId = `ad-${position}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            ads[position] = `<div class="ad-container" id="${adId}">${settings[`${position}Code`]}</div>`;
          } else {
            ads[position] = '';
          }
        });
        return ads;
      } catch (error) {
        console.error('Error rendering ads:', error);
        return { top: '', side: '', bottom: '' };
      }
    }

    // ===== تحديث معاينة الإعلان =====
    function updateAdPreview(position, code) {
      const preview = document.getElementById(`adPreview${position.charAt(0).toUpperCase() + position.slice(1)}`);
      if (preview) {
        preview.innerHTML = code || 'معاينة الإعلان';
      }
    }

    // ===== الترجمات =====
    const translations = {
      ar: {
        welcome_title: "مرحباً بكم في غرفة الأسرار",
        user_info_title: "معلوماتك الشخصية",
        user_info_desc: "ساعدنا لنعرفك أكثر لتقديم تحليل دقيق",
        gender_label: "الجنس",
        dob_label: "تاريخ الميلاد",
        submit_user_info: "التالي",
        intro_title: "استعد لرحلة اكتشاف الذات",
        intro_subtitle: "حلل شخصيتك وجد شريك حياتك المثالي",
        intro_desc: "ستقوم برحلة من 20 سؤالاً مصممة لكشف أعماق شخصيتك",
        start_btn: "ابدأ الاختبار",
        next_btn: "التالي",
        prev_btn: "السابق",
        finish_btn: "إنهاء",
        restart_btn: "ابدأ من جديد",
        share_btn: "مشاركة النتيجة",
        copy_btn: "نسخ النتيجة",
        history_btn: "سجل النتائج",
        print_btn: "طباعة النتيجة",
        settings_btn: "الإعدادات",
        lang_btn: "English",
        alert_missing_fields: "يرجى ملء جميع الحقول",
        alert_invalid_dob: "تاريخ ميلاد غير صحيح",
        alert_no_answer: "يرجى اختيار إجابة",
        alert_copied: "تم نسخ النتيجة بنجاح!",
        alert_shared: "تمت مشاركة النتيجة بنجاح!",
        loading_analysis: "جاري تحليل شخصيتك...",
        footer1: "جميع الحقوق محفوظة © 2025| تم التصميم والتطوير بواسطة <strong>Mohammed Tarek</strong>",
        footer2: "مطور بحب ❤️ لمساعدتك في فهم نفسك أكثر",
        male: "ذكر",
        female: "أنثى",
        other: "آخر",
        compatibility_title: "نسبة التوافق",
        partner_traits: "صفات الشريك المثالي",
        relationship_advice: "نصائح للعلاقة",
        analysis_intro: "بعد تحليل إجاباتك، تم تحديد طبيعة شخصيتك على النحو التالي:",
        personality_section: "تحليل شخصيتك",
        partner_section: "الشريك المثالي لك",
        partner_analysis_title: "تحليل مفصل للشريك المثالي",
        history_title: "سجل النتائج السابقة",
        no_history: "لا توجد نتائج سابقة",
        chart_title: "تحليل الشخصية (نموذج DISC)",
        age_label: "العمر",
        zodiac_sign: "برجك",
        overview: "نظرة عامة",
        core_traits: "السمات الأساسية",
        psychological_profile: "الملف النفسي",
        work_behavior: "السلوك في العمل",
        relationship_style: "أسلوبك في العلاقات",
        learning_style: "أسلوب التعلم",
        values_principles: "القيم والمبادئ",
        communication_patterns: "أنماط التواصل",
        decision_making: "اتخاذ القرار",
        leadership_style: "أسلوب القيادة",
        conflict_resolution: "حل النزاعات",
        motivation_factors: "عوامل التحفيز",
        ideal_environment: "البيئة المثالية",
        growth_areas: "مجالات النمو",
        life_balance: "التوازن في الحياة",
        career_paths: "المسارات المهنية",
        relationship_needs: "احتياجات العلاقة",
        compatibility_factors: "عوامل التوافق",
        long_term_potential: "الإمكانات طويلة الأمد",
        compatible_zodiacs: "الأبراج المتوافقة",
        visitors_count: "عدد الزوار",
        analyses_count: "عدد التحليلات",
        rate_site: "قيم موقعنا",
        rate_analysis: "قيم تحليلك",
        write_comment: "اكتب تعليقك هنا...",
        submit_feedback: "إرسال التقييم",
        ideal_partner: "الشريك المثالي لك",
        partner_type: "نوع الشريك",
        partner_traits: "صفات الشريك",
        similar_personalities: "شخصيات مشابهة لك",
        personality_color: "لون شخصيتك",
        colors: { D: "الأحمر", I: "الأصفر", S: "الأخضر", C: "الأزرق" },
        shared_feedback: "آراء المستخدمين",
        no_feedback: "لا توجد تعليقات بعد",
        average_rating: "متوسط التقييم"
      },
      en: {
        welcome_title: "Welcome to Chamber of Secrets",
        user_info_title: "Your Personal Information",
        user_info_desc: "Let us know you better to provide accurate analysis",
        gender_label: "Gender",
        dob_label: "Date of Birth",
        submit_user_info: "Next",
        intro_title: "Get Ready for a Journey of Self-Discovery",
        intro_subtitle: "Analyze Your Personality & Find Your Ideal Partner",
        intro_desc: "You will take a 20-question journey designed to uncover the depths of your personality",
        start_btn: "Start Test",
        next_btn: "Next",
        prev_btn: "Previous",
        finish_btn: "Finish",
        restart_btn: "Restart",
        share_btn: "Share Result",
        copy_btn: "Copy Result",
        history_btn: "History",
        print_btn: "Print Result",
        settings_btn: "Settings",
        lang_btn: "العربية",
        alert_missing_fields: "Please fill all fields",
        alert_invalid_dob: "Invalid date of birth",
        alert_no_answer: "Please select an answer",
        alert_copied: "Result copied successfully!",
        alert_shared: "Result shared successfully!",
        loading_analysis: "Analyzing your personality...",
        footer1: "All rights reserved © 2025 | Designed & Developed by <strong>Mohammed Tarek</strong>",
        footer2: "Developer with love ❤️ to help you understand yourself better",
        male: "Male",
        female: "Female",
        other: "Other",
        compatibility_title: "Compatibility Rate",
        partner_traits: "Ideal Partner Traits",
        relationship_advice: "Relationship Advice",
        analysis_intro: "Based on your answers, your personality type is:",
        personality_section: "Your Personality Analysis",
        partner_section: "Your Ideal Partner",
        partner_analysis_title: "Detailed Partner Analysis",
        history_title: "Previous Results",
        no_history: "No previous results",
        chart_title: "Personality Analysis (DISC Model)",
        age_label: "Age",
        zodiac_sign: "Zodiac Sign",
        overview: "Overview",
        core_traits: "Core Traits",
        psychological_profile: "Psychological Profile",
        work_behavior: "Work Behavior",
        relationship_style: "Relationship Style",
        learning_style: "Learning Style",
        values_principles: "Values & Principles",
        communication_patterns: "Communication Patterns",
        decision_making: "Decision Making",
        leadership_style: "Leadership Style",
        conflict_resolution: "Conflict Resolution",
        motivation_factors: "Motivation Factors",
        ideal_environment: "Ideal Environment",
        growth_areas: "Growth Areas",
        life_balance: "Life Balance",
        career_paths: "Career Paths",
        relationship_needs: "Relationship Needs",
        compatibility_factors: "Compatibility Factors",
        long_term_potential: "Long-term Potential",
        compatible_zodiacs: "Compatible Zodiacs",
        visitors_count: "Visitors Count",
        analyses_count: "Analyses Count",
        rate_site: "Rate Our Site",
        rate_analysis: "Rate Your Analysis",
        write_comment: "Write your comment here...",
        submit_feedback: "Submit Feedback",
        ideal_partner: "Your Ideal Partner",
        partner_type: "Partner Type",
        partner_traits: "Partner Traits",
        similar_personalities: "Similar Personalities",
        personality_color: "Your Personality Color",
        colors: { D: "Red", I: "Yellow", S: "Green", C: "Blue" },
        shared_feedback: "User Feedback",
        no_feedback: "No feedback yet",
        average_rating: "Average Rating"
      }
    };

    // ===== الأسئلة =====
    const questions = {
      ar: [
        { id: 1, text: "عندما تستيقظ في الصباح، ما أول شيء يخطر ببالك؟", options: [
          { text: "أنا متحمس لأبدأ يومي!", trait: "I", score: 4 },
          { text: "هل كل شيء تحت السيطرة؟", trait: "C", score: 3 },
          { text: "هل سأكون كافيًا اليوم؟", trait: "S", score: 2 },
          { text: "أريد أن أفهم معنى هذا اليوم", trait: "C", score: 3 }
        ]},
        { id: 2, text: "في لقاء اجتماعي جديد، ماذا تفعل؟", options: [
          { text: "أبدأ الحديث مع الجميع بسرعة", trait: "I", score: 4 },
          { text: "أراقب أولًا ثم أتحدث مع شخص واحد", trait: "S", score: 4 },
          { text: "أركز على من يمكن أن يفيدني أو أفيد منه", trait: "D", score: 3 },
          { text: "أحاول فهم مشاعر الآخرين بسرعة", trait: "S", score: 4 }
        ]},
        // ... (الأسئلة الأخرى بنفس الهيكل)
      ],
      en: [
        { id: 1, text: "When you wake up in the morning, what's the first thing on your mind?", options: [
          { text: "I'm excited to start my day!", trait: "I", score: 4 },
          { text: "Is everything under control?", trait: "C", score: 3 },
          { text: "Will I be enough today?", trait: "S", score: 2 },
          { text: "I want to understand the meaning of this day", trait: "C", score: 3 }
        ]},
        { id: 2, text: "At a new social gathering, what do you do?", options: [
          { text: "I start talking to everyone quickly", trait: "I", score: 4 },
          { text: "I observe first, then talk to one person", trait: "S", score: 4 },
          { text: "I focus on who can benefit me or I can benefit them", trait: "D", score: 3 },
          { text: "I try to understand others' feelings quickly", trait: "S", score: 4 }
        ]},
        // ... (الأسئلة الأخرى)
      ]
    };

    // ===== تحليل الشخصية =====
    function analyzePersonality() {
      try {
        const scores = { D: 0, I: 0, S: 0, C: 0 };
        state.userAnswers.forEach(answer => {
          if (answer.trait !== undefined && answer.score !== undefined) {
            scores[answer.trait] += answer.score;
          }
        });
        const primary = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
        return { scores, primary };
      } catch (error) {
        console.error('Error analyzing personality:', error);
        return { scores: { D: 0, I: 0, S: 0, C: 0 }, primary: 'D' };
      }
    }

    // ===== توليد التحليل التفصيلي =====
    function getDetailedAnalysis(personalityType, lang) {
      const analysis = {
        ar: {
          D: {
            core_traits: "قوي، طموح، واثق، مهيمن، متحفظ، مباشر، مستقل، طموح، فعال، حازم",
            psychological_profile: "يتمتع بعقل تحليلي وقوة اتخاذ القرار. يميل إلى التفكير الاستراتيجي والعمل بسرعة. يشعر بالراحة في بيئة تنافسية حيث يمكنه السيطرة. قد يكون أحيانًا قاسيًا أو غير متسامح مع البطء.",
            work_behavior: "يحب التحديات، يتخذ قرارات سريعة، يقود بثقة، يركز على النتائج، يكره الروتين.",
            relationship_style: "واثق، مباشر، يحترم القوة، يقدر الاحترام المتبادل، قد يكون مسيطرًا.",
            learning_style: "تعلم عملي، يفضل التعلم من خلال التجربة، يكره النظريات الطويلة.",
            values_principles: "القوة، الاستقلال، الإنجاز، الكفاءة، التحدي.",
            communication_patterns: "مباشر، واضح، مختصر، يركز على الأهداف.",
            decision_making: "سريع، حاسم، يعتمد على الحقائق والمنطق.",
            leadership_style: "قيادته مباشرة وتوجيهية. يوضح التوقعات ويعطي تعليمات واضحة.",
            conflict_resolution: "يواجه النزاعات مباشرة وبشجاعة.",
            motivation_factors: "النجاح، التحدي، السلطة، الاستقلال، الإنجازات.",
            ideal_environment: "بيئة ديناميكية، تنافسية، تسمح بالسيطرة والمبادرة.",
            growth_areas: "الصبر، الاستماع، التعاون، التعبير عن المشاعر.",
            life_balance: "يحتاج إلى تحقيق التوازن بين العمل والحياة الشخصية.",
            career_paths: "ريادة الأعمال، الإدارة، المبيعات، القيادة، القانون.",
            relationship_needs: "الاحترام، التحدي، الاستقلال، التقدير."
          },
          // ... (أنواع I, S, C بنفس الهيكل)
        },
        en: {
          D: {
            core_traits: "Strong, ambitious, confident, dominant, reserved, direct, independent, driven, efficient, decisive",
            psychological_profile: "Analytical mind and strong decision-making. Strategic thinker, acts quickly. Comfortable in competitive environments. May be harsh or intolerant of slowness.",
            // ... (التحليلات بالإنجليزية)
          }
          // ... (I, S, C)
        }
      };
      return analysis[lang][personalityType] || analysis[lang].D;
    }

    // ===== الشريك المثالي =====
    function getPartnerInfo(personalityType, lang) {
      const partnerData = {
        ar: {
          D: { type: "شريك داعم ومستقل", traits: "صبور، يفهمك، يحترم طموحك، يدعم قراراتك، يقدّر استقلاليتك", color: "#10b981" },
          I: { type: "شريك مستمع ومحفّز", traits: "صبور، داعم، يقدّر طاقتك، يستمع جيدًا، يشاركك الحماس", color: "#3b82f6" },
          S: { type: "شريك موثوق ومستقر", traits: "وفيّ، داعم، يقدّر الولاء، يوفر الأمان، متعاطف", color: "#f59e0b" },
          C: { type: "شريك ذكي ومنظم", traits: "منطقي، دقيق، يحترم ذكاءك، يقدّر التخطيط، عملي", color: "#ec4899" }
        },
        en: {
          D: { type: "Supportive and Independent Partner", traits: "Patient, understanding, respects your ambitions, supports your decisions, values your independence", color: "#10b981" },
          I: { type: "Listening and Encouraging Partner", traits: "Patient, supportive, values your energy, listens attentively, shares your enthusiasm", color: "#3b82f6" },
          S: { type: "Reliable and Stable Partner", traits: "Loyal, supportive, values loyalty, provides security, empathetic", color: "#f59e0b" },
          C: { type: "Intelligent and Organized Partner", traits: "Logical, precise, respects your intelligence, values planning, practical", color: "#ec4899" }
        }
      };
      return partnerData[lang][personalityType] || partnerData[lang].D;
    }

    // ===== شخصيات مشابهة =====
    function getSimilarPersonalities(type, lang) {
      const data = {
        ar: {
          D: ["أنجيلا ميركل", "دونالد ترامب", "مارثا ستيوارت", "غابرييل ماركيز"],
          I: ["أوبرا وينفري", "باراك أوباما", "رانيا العبدالله", "نجيب محفوظ"],
          S: ["الملك سلمان", "كوفي عنان", "مادلين أولبرايت", "نجيب محفوظ"],
          C: ["ستيف جوبز", "بيل غيتس", "ماري كوري", "ألبرت آينشتاين"]
        },
        en: {
          D: ["Angela Merkel", "Donald Trump", "Martha Stewart", "Gabriel Garcia Marquez"],
          I: ["Oprah Winfrey", "Barack Obama", "Queen Rania", "Naguib Mahfouz"],
          S: ["King Salman", "Kofi Annan", "Madeleine Albright", "Naguib Mahfouz"],
          C: ["Steve Jobs", "Bill Gates", "Marie Curie", "Albert Einstein"]
        }
      };
      return data[lang][type] || [];
    }

    // ===== عرض النتائج =====
    function renderResult() {
      try {
        const { scores, primary } = analyzePersonality();
        const t = translations[state.lang];
        const types = {
          ar: { D: "القائد المهيمن (الأحمر)", I: "الشخصية المؤثرة (الأصفر)", S: "الشخصية المستقرة (الأخضر)", C: "الشخصية الواعية (الأزرق)" },
          en: { D: "Dominant Leader (Red)", I: "Influential Personality (Yellow)", S: "Stable Personality (Green)", C: "Conscientious Personality (Blue)" }
        };

        const typeName = types[state.lang][primary];
        const analysis = getDetailedAnalysis(primary, state.lang);
        const partnerInfo = getPartnerInfo(primary, state.lang);
        const similarPersonalities = getSimilarPersonalities(primary, state.lang);

        const personalityColors = { D: '#ef4444', I: '#f59e0b', S: '#10b981', C: '#3b82f6' };

        const resultData = {
          scores, primary,
          date: new Date().toISOString(),
          age: calculateAge(state.userData.dob),
          zodiac: calculateZodiac(state.userData.dob),
          partnerType: partnerInfo.type,
          personalityColor: personalityColors[primary],
          similarPersonality: similarPersonalities[0]
        };
        state.resultData = resultData;
        saveResult(resultData);

        // تحديث العدادات
        updateCounters();

        // بناء واجهة النتائج
        const resultHTML = `
          <div class="glass-card rounded-xl p-8 max-w-4xl mx-auto">
            <h2 class="text-3xl font-bold mb-6 gradient-text">${t.personality_section}</h2>
            <p class="text-gray-300 mb-6">${t.analysis_intro}</p>
            <!-- مخطط دائري -->
            <div class="chart-container">
              <canvas id="personalityChart"></canvas>
            </div>
            <!-- تفاصيل التحليل -->
            <div class="mb-8">${generateAnalysisSections(analysis, t, primary)}</div>
            <!-- زر المشاركة -->
            <div class="text-center mt-8">
              <button id="copyBtn" class="btn-secondary">${t.copy_btn}</button>
              <button id="shareBtn" class="btn-primary">${t.share_btn}</button>
            </div>
          </div>
        `;
        document.getElementById('app').innerHTML = resultHTML;

        // رسم المخطط
        renderChart(scores);

      } catch (error) {
        console.error('Error rendering result:', error);
      }
    }

    // ===== رسم المخطط =====
    function renderChart(scores) {
      const ctx = document.getElementById('personalityChart').getContext('2d');
      new Chart(ctx, {
        type: 'radar',
        data: {
          labels: ['D', 'I', 'S', 'C'],
          datasets: [{
            label: 'مستوى الشخصية',
            data: [scores.D, scores.I, scores.S, scores.C],
            backgroundColor: 'rgba(59, 130, 246, 0.2)',
            borderColor: '#3b82f6',
            pointBackgroundColor: '#3b82f6'
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    // ===== عرض رسالة إشعار =====
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.opacity = 1;
      setTimeout(() => toast.style.opacity = 0, 3000);
    }

    // ===== معالجة الأحداث =====
    function setupEventListeners() {
      const app = document.getElementById('app');
      app.addEventListener('click', (e) => {
        const t = translations[state.lang];

        // معالجة إرسال معلومات المستخدم
        if (e.target.id === 'submitUserInfo') {
          const gender = document.getElementById('gender')?.value;
          const dob = document.getElementById('dob')?.value;
          if (!gender || !dob || !isValidDate(dob)) {
            showToast(t.alert_missing_fields);
            return;
          }
          state.userData = { gender, dob };
          state.page = 'intro';
          render();
        }

        // معالجة زر البدء
        if (e.target.id === 'startBtn') {
          state.page = 'quiz';
          state.currentQ = 0;
          render();
        }

        // معالجة زر التالي
        if (e.target.id === 'nextBtn') {
          const selected = document.querySelector('input[name="answer"]:checked');
          if (!selected && state.currentQ < questions[state.lang].length) {
            showToast(t.alert_no_answer);
            return;
          }
          if (selected) {
            state.userAnswers[state.currentQ] = JSON.parse(selected.value);
          }
          state.currentQ++;
          if (state.currentQ >= questions[state.lang].length) {
            state.page = 'result';
            render();
          } else {
            render();
          }
        }

        // معالجة زر المشاركة
        if (e.target.id === 'shareBtn') {
          if (navigator.share) {
            navigator.share({ text: t.alert_shared });
          } else {
            showToast(t.alert_shared);
          }
        }

        // معالجة زر النسخ
        if (e.target.id === 'copyBtn') {
          navigator.clipboard.writeText("نتائج تحليل شخصيتك...");
          showToast(t.alert_copied);
        }

        // معالجة زر السجل
        if (e.target.id === 'historyBtn') {
          state.page = 'history';
          render();
        }

        // معالجة زر الإعدادات
        if (e.target.id === 'settingsBtn') {
          document.getElementById('settingsOverlay').style.display = 'flex';
        }

        if (e.target.id === 'closeSettings') {
          document.getElementById('settingsOverlay').style.display = 'none';
        }
      });
    }

    // ===== عرض الصفحة =====
    function render() {
      const t = translations[state.lang];
      let content = '';

      switch (state.page) {
        case 'userInfo':
          content = renderUserInfo(t);
          break;
        case 'intro':
          content = renderIntro(t);
          break;
        case 'quiz':
          content = renderQuiz(t);
          break;
        case 'result':
          renderResult();
          return;
        case 'history':
          content = renderHistory(t);
          break;
        default:
          content = renderUserInfo(t);
      }

      const ads = renderAds();
      document.getElementById('app').innerHTML = `${ads.top} ${content} ${ads.bottom}`;
    }

    // ===== تشغيل التطبيق =====
    function initApp() {
      updateAdStatus();
      render();
      setupEventListeners();
    }

    // تشغيل التطبيق عند التحميل
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
