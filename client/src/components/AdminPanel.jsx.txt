import { useState, useEffect } from 'react'
import DOMPurify from 'dompurify'
import * as api from '../services/api.js'
import ToggleSwitch from './ToggleSwitch.jsx'
import AdPreview from './AdPreview.jsx'

function AdminPanel({ ads, setAds, showToast }) {
  const [password, setPassword] = useState('')
  const [loggedIn, setLoggedIn] = useState(false)
  const [adSettings, setAdSettings] = useState(ads)

  const handleLogin = async () => {
    const token = await api.login({ password })
    if (token) {
      localStorage.setItem('adminToken', token)
      setLoggedIn(true)
      showToast('Logged in successfully')
    } else {
      showToast('Invalid password')
    }
  }

  const handleSave = async () => {
    const sanitized = {
      topCode: DOMPurify.sanitize(adSettings.topCode),
      // ... Sanitize others
    }
    const response = await api.updateAds(sanitized)
    if (response) {
      setAds(adSettings)
      showToast('Ads updated')
    }
  }

  return (
    <div>
      {!loggedIn ? (
        <div>
          <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} />
          <button onClick={handleLogin}>Login</button>
        </div>
      ) : (
        <div>
          {/* Toggles and textareas for ads */}
          <ToggleSwitch checked={adSettings.top} onChange={() => setAdSettings(prev => ({ ...prev, top: !prev.top }))} />
          <textarea value={adSettings.topCode} onChange={(e) => setAdSettings(prev => ({ ...prev, topCode: e.target.value }))} />
          <AdPreview code={adSettings.topCode} />
          {/* Similar for side and bottom */}
          <button onClick={handleSave}>Save</button>
        </div>
      )}
    </div>
  )
}

export default AdminPanel