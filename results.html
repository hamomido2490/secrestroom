<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>نتائج التحليل | غرفة الأسرار</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      direction: rtl;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .site-title {
      color: #333;
      text-align: center;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .result-title {
      color: #009688;
      text-align: center;
      margin-bottom: 30px;
      font-size: 24px;
    }

    #user-info {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: center;
    }

    #user-info p {
      margin: 5px 0;
      font-size: 18px;
    }

    .summary-box {
      background: linear-gradient(45deg, #009688, #4caf50);
      color: white;
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 30px;
      text-align: center;
    }

    .summary-box h3 {
      margin-bottom: 15px;
      font-size: 22px;
    }

    .summary-box p {
      font-size: 18px;
      line-height: 1.6;
    }

    .analysis-section {
      margin-bottom: 30px;
    }

    .analysis-section h3 {
      color: #333;
      text-align: center;
      margin-bottom: 20px;
      font-size: 22px;
    }

    .theory-block {
      background: #f8f9fa;
      margin: 15px 0;
      padding: 20px;
      border-radius: 10px;
      border-right: 4px solid #009688;
    }

    .theory-block h4 {
      color: #009688;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .theory-block p {
      color: #555;
      line-height: 1.6;
      font-size: 16px;
    }

    button {
      display: block;
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      border: none;
      border-radius: 8px;
      font-family: 'Tajawal', sans-serif;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    button:nth-child(1) {
      background: #f44336;
      color: white;
    }

    button:nth-child(2) {
      background: #2196f3;
      color: white;
    }

    button:nth-child(3) {
      background: #9e9e9e;
      color: white;
    }

    footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eee;
      color: #666;
    }

    @media (max-width: 600px) {
      .container {
        padding: 15px;
      }
      
      .site-title {
        font-size: 24px;
      }
      
      .result-title {
        font-size: 20px;
      }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <h1 class="site-title">غرفة الأسرار | Secrets Room</h1>
    <h2 class="result-title">نتيجتك النفسية الكاملة</h2>

    <div id="user-info"></div>

    <div id="summary" class="summary-box"></div>

    <div id="detailed-analysis" class="analysis-section"></div>

    <button onclick="downloadPDF()">📄 تحميل تقرير PDF</button>
    <button onclick="copySummary()">📋 نسخ التحليل المختصر</button>
    <button onclick="window.location.href='index.html'">🏠 العودة للرئيسية</button>

    <footer>
      <p>© 2025 Mohammed Tarek - جميع الحقوق محفوظة</p>
    </footer>
  </div>

  <script>
    // استرجاع البيانات من localStorage
    const psychologyAnalysis = JSON.parse(localStorage.getItem('psychologyAnalysis'));
    
    if (!psychologyAnalysis) {
      window.location.href = 'index.html';
    }

    // 1. عرض بيانات المستخدم
    document.getElementById('user-info').innerHTML = `
      <p><strong>العمر:</strong> ${psychologyAnalysis.demographic.age}</p>
      <p><strong>الجنس:</strong> ${psychologyAnalysis.demographic.gender}</p>
    `;

    // 2. توليد تحليل مختصر محسّن
    function generateSummary() {
      const categories = psychologyAnalysis.analysis;
      let traits = [];
      
      // تحليل مبسط للسمات بناءً على الإجابات
      const freudScore = categories.freud ? 
        categories.freud.filter(a => a.answer.includes('موافق')).length / categories.freud.length * 100 : 0;
      
      const adlerScore = categories.adler ? 
        categories.adler.filter(a => a.answer.includes('موافق')).length / categories.adler.length * 100 : 0;
      
      const jungScore = categories.jung ? 
        categories.jung.filter(a => a.answer.includes('موافق')).length / categories.jung.length * 100 : 0;

      if (freudScore > 60) traits.push('عميقة ورمزية');
      if (adlerScore > 60) traits.push('ambitious وطموحة');
      if (jungScore > 60) traits.push('روحانية ومتصلة باللاواعي');

      if (traits.length === 0) traits.push('متوازنة ومرنة');

      return `أنت شخصية ${traits.join('، ')} بناءً على إجاباتك الشاملة.`;
    }

    const summaryText = generateSummary();
    document.getElementById('summary').innerHTML = `
      <h3>📊 التحليل المختصر</h3>
      <p>${summaryText}</p>
    `;

    // 3. توليد تحليل تفصيلي محسّن
    function generateDetailedAnalysis() {
      const categories = psychologyAnalysis.analysis;
      const analysis = {};

      // تحليل فرويد
      if (categories.freud) {
        const score = categories.freud.filter(a => a.answer.includes('موافق')).length / categories.freud.length * 100;
        analysis['التحليل الكلاسيكي (فرويد)'] = 
          score > 70 ? 'تشير إجاباتك إلى تأثير قوي لللاوعي على سلوكك، مع تركيز على الرموز والأحلام كوسيلة لفهم الذات.' :
          score > 40 ? 'تظهر لديك وعي متوسط بالتأثيرات اللاواعية، مع فهم جيد للآليات الدفاعية.' :
          'لديك وعي عالي بالعقل الواعي، مع تركيز أقل على التحليل الرمزي للسلوك.';
      }

      // تحليل أدلر
      if (categories.adler) {
        const score = categories.adler.filter(a => a.answer.includes('موافق')).length / categories.adler.length * 100;
        analysis['علم النفس الفردي (أدلر)'] = 
          score > 70 ? 'تشير إجاباتك إلى سعي قوي للتفوق والتميز، مع وعي بالحاجة للتقدير الاجتماعي.' :
          score > 40 ? 'تظهر لديك دوافع متوسطة للتفوق، مع توازن بين الذات والمجتمع.' :
          'تفضل الاستقرار والراحة، مع تركيز أقل على المنافسة والتفوق.';
      }

      // تحليل يونغ
      if (categories.jung) {
        const score = categories.jung.filter(a => a.answer.includes('موافق')).length / categories.jung.length * 100;
        analysis['التحليل التحليلي (يونغ)'] = 
          score > 70 ? 'تظهر لديك اتصال قوي باللاوعي الجمعي، مع وعي بالأركيتايبات والرموز الروحية.' :
          score > 40 ? 'لديك وعي متوسط بالجوانب الروحية والرمزية في شخصيتك.' :
          'تركز أكثر على الواقع والعقل الواعي، مع اهتمام أقل بالجوانب الروحية.';
      }

      // تحليل MBTI
      if (categories.mbti) {
        const introversion = categories.mbti.filter(a => a.answer.includes('غير موافق')).length;
        const extroversion = categories.mbti.filter(a => a.answer.includes('موافق')).length;
        analysis['MBTI - مؤشر مايرز بريغز'] = 
          introversion > extroversion ? 'تشير إجاباتك إلى نمط شخصية من introvert، تفضل الوحدة والتأمل الداخلي.' :
          extroversion > introversion ? 'تشير إجاباتك إلى نمط شخصية من extrovert، تفضل التفاعل الاجتماعي والنشاط.' :
          'تظهر لديك توازن جيد بين الانعزال والتفاعل الاجتماعي.';
      }

      // تحليل Big Five
      if (categories.bigfive) {
        const openness = categories.bigfive.filter(a => a.answer.includes('موافق')).length / categories.bigfive.length * 100;
        analysis['Big Five - السمات الخمس الكبرى'] = 
          openness > 70 ? 'درجاتك المرتفعة في الانفتاح تشير إلى شخصية مبدعة ومحبة للمغامرة والتجارب الجديدة.' :
          openness > 40 ? 'تظهر لديك توازن جيد بين الاستقرار والمغامرة في تجاربك اليومية.' :
          'تفضل الاستقرار والروتين، مع تركيز أقل على التجارب الجديدة.';
      }

      // تحليل TA
      if (categories.ta) {
        const adult = categories.ta.filter(a => a.answer.includes('موافق')).length / categories.ta.length * 100;
        analysis['تحليل التفاعلات (TA)'] = 
          adult > 70 ? 'تشير إجاباتك إلى سيطرة الحالة البالغة، مع اتخاذ قرارات منطقية ومتوازنة.' :
          adult > 40 ? 'تظهر لديك توازن جيد بين الحالة البالغة والطفلية في تعاملك مع الآخرين.' :
          'قد تتأثر أحياناً بالمشاعر والانفعالات في تعاملك مع الآخرين.';
      }

      return analysis;
    }

    const detailedAnalysis = generateDetailedAnalysis();
    let detailHTML = '<h3>🔍 التحليل التفصيلي حسب النظريات</h3>';
    
    for (const [theory, content] of Object.entries(detailedAnalysis)) {
      if (content) { // عرض فقط إذا كان هناك تحليل
        detailHTML += `<div class='theory-block'><h4>${theory}</h4><p>${content}</p></div>`;
      }
    }
    
    document.getElementById('detailed-analysis').innerHTML = detailHTML;

    // 4. توليد تقرير PDF محسّن
    function downloadPDF() {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // إعداد الخط العربي
        doc.setFont("helvetica");
        
        // العنوان الرئيسي
        doc.setFontSize(16);
        doc.setTextColor(0, 0, 0);
        doc.text("نتائج التحليل النفسي - غرفة الأسرار", 105, 20, null, null, 'center');
        
        // بيانات المستخدم
        doc.setFontSize(12);
        doc.text(`العمر: ${psychologyAnalysis.demographic.age}`, 20, 35);
        doc.text(`الجنس: ${psychologyAnalysis.demographic.gender}`, 150, 35);
        
        // التحليل المختصر
        doc.setFontSize(14);
        doc.setTextColor(0, 100, 0);
        doc.text("التحليل المختصر:", 20, 50);
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        doc.text(summaryText, 20, 60, { maxWidth: 170 });
        
        // التحليل التفصيلي
        let y = 80;
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 255);
        doc.text("التحليل التفصيلي:", 20, y);
        y += 10;
        
        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);
        
        Object.entries(detailedAnalysis).forEach(([theory, content], index) => {
          if (content && y < 270) { // التأكد من عدم تجاوز حجم الصفحة
            doc.setFontSize(12);
            doc.setTextColor(100, 0, 0);
            doc.text(theory + ":", 20, y);
            y += 8;
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            const lines = doc.splitTextToSize(content, 170);
            doc.text(lines, 20, y);
            y += lines.length * 7 + 5;
          }
        });
        
        // التاريخ والوقت
        const date = new Date().toLocaleDateString('ar-SA');
        doc.setFontSize(8);
        doc.setTextColor(128, 128, 128);
        doc.text(`تاريخ التحليل: ${date}`, 20, 280);
        doc.text("© 2025 Mohammed Tarek", 150, 280);
        
        doc.save("تحليل_نفسي_متكامل.pdf");
      } catch (error) {
        console.error('Error generating PDF:', error);
        alert('حدث خطأ أثناء إنشاء ملف PDF. يرجى المحاولة مرة أخرى.');
      }
    }

    // 5. نسخ التحليل المختصر
    function copySummary() {
      navigator.clipboard.writeText(summaryText).then(() => {
        alert("✅ تم نسخ التحليل المختصر بنجاح!");
      }).catch(err => {
        console.error('Failed to copy: ', err);
        // نسخ احتياطي باستخدام prompt
        const textArea = document.createElement('textarea');
        textArea.value = summaryText;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert("✅ تم نسخ التحليل المختصر بنجاح!");
      });
    }
  </script>
</body>
</html>
